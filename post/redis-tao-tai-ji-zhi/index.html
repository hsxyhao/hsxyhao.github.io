<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="Java | ä¸ªäººåšå®¢ | Gridea | NexT | next">
<meta name="description" content="Gridea Next | æ‡‚ç‚¹å‰ç«¯çš„åç«¯ | ä¸­é—´ä»¶ | Java">
<meta name="theme-color" content="#222">
<title>Redisæ·˜æ±°æœºåˆ¶ | Madara</title>
<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/favicon.ico?v=1583652196083">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/css/gemini.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/fonts/font-awesome.css">
<link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">

<link href="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/hljs/styles/default.css" rel="stylesheet">  

<script src="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/hljs/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.ui.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>

    <meta name="description" content="Redisæ·˜æ±°æœºåˆ¶" />
    <meta name="keywords" content="Redis" />
  </head>
  <body>
    <div class="head-top-line"></div>
    <div class="header-box">
      
<div class=" gemini">
  <header class="header bg-color ">
    <div class="blog-header box-shadow-wrapper bg-color " id="header">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-meta">       
        <div class="site-title">
          
            <a href="/" class="brand">
              <span>Madara</span>
            </a>  
          
        </div>
        
          <p class="subtitle">ç²¾äºå¿ƒï¼Œç®€äºå½¢</p>
        
      </div>
      <nav class="site-nav" id="site_nav">
        <ul id="nav_ul">
          
            <li class="nav-item ">
              
              
                
                  <a href="/" target="_self">
                    <i class="fa fa-home"></i> é¦–é¡µ
                  </a>
                
              
            </li>
          
            <li class="nav-item ">
              
              
                
                  <a href="/archives" target="_self">
                    <i class="fa fa-archive"></i> å½’æ¡£
                  </a>
                
              
            </li>
          
            <li class="nav-item ">
              
              
                
                  <a href="/tags" target="_self">
                    <i class="fa fa-tags"></i> æ ‡ç­¾
                  </a>
                
              
            </li>
          
            <li class="nav-item ">
              
              
                
                  <a href="/post/about" target="_self">
                    <i class="fa fa-user"></i> å…³äº
                  </a>
                
              
            </li>
          
          <li class="nav-item">
            <a>
              <i class="fa fa-search"></i> æœç´¢
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
</div>

<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function navClick() {
    let sideBar = document.querySelector('.sidebar');
    let navUl = document.querySelector('#nav_ul');
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
    if (siteNav.classList.contains('nav-menu-active')) {
      siteNav.style = "height: " + (navUl.children.length * 42) +"px !important";
    } else {
      siteNav.style = "";
    }
  }

  navToggle.addEventListener('click',navClick);  
</script>
    </div>
    <div class="main-continer">
      
      <div class="section-layout gemini ">
        <div class="section-layout-wrapper">
          

<div class="sidebar">
  
    <div class="sidebar-box box-shadow-wrapper bg-color right-motion" id="sidebar">
      
      <div class="sidebar-body gemini" id="sidebar_body">
        
          
            <div style="opacity: 1;">
              <div class="toc-box right-motion">
  <div class="toc-wrapper auto-number no_compress" id="toc_wrapper">
    <ul class="markdownIt-TOC">
<li><a href="#%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5">åˆ é™¤ç­–ç•¥</a></li>
<li><a href="#%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5">æ·˜æ±°ç­–ç•¥</a></li>
<li><a href="#lru%E7%AE%97%E6%B3%95">LRUç®—æ³•</a>
<ul>
<li><a href="#lru%E7%AE%97%E6%B3%95%E7%94%B1%E6%9D%A5">lruç®—æ³•ç”±æ¥</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%87%87%E7%94%A8%E8%BF%91%E4%BC%BC%E7%9A%84lru%E7%AE%97%E6%B3%95">ä¸ºä»€ä¹ˆé‡‡ç”¨è¿‘ä¼¼çš„LRUç®—æ³•</a></li>
<li><a href="#redis30%E4%B8%AD%E5%AF%B9lru%E7%AE%97%E6%B3%95%E7%9A%84%E6%94%B9%E8%BF%9B">redis3.0ä¸­å¯¹lruç®—æ³•çš„æ”¹è¿›</a></li>
</ul>
</li>
<li><a href="#lfu%E7%AE%97%E6%B3%95">LFUç®—æ³•</a>
<ul>
<li><a href="#%E7%94%B1%E6%9D%A5">ç”±æ¥</a></li>
<li><a href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88">è®¾è®¡æ–¹æ¡ˆ</a>
<ul>
<li><a href="#lfu%E8%AE%BE%E8%AE%A1%E6%BA%90%E7%A0%81">LFUè®¾è®¡æºç </a></li>
</ul>
</li>
<li><a href="#lru-lfu%E7%AE%97%E6%B3%95%E6%B5%8B%E8%AF%95">lruã€lfuç®—æ³•æµ‹è¯•</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">å‚è€ƒé“¾æ¥</a></li>
</ul>

  </div>
</div>

<script>

let lastTop = 0, lList = [], hList = [], postBody, lastIndex = -1; 
let active = 'active-show', activeClass = 'active-current';
let tocWrapper = document.querySelector('#toc_wrapper');
let tocContent = tocWrapper.children[0];
let autoNumber = tocWrapper&&tocWrapper.classList.contains('auto-number');

function addTocNumber(elem, deep) {
  if (!elem) {
    return;
  }
  let prop = elem.__proto__;

  if (prop === HTMLUListElement.prototype) {
    for (let i = 0; i < elem.children.length; i++) {
      addTocNumber(elem.children[i], deep + (i + 1) + '.');
    }
  } else if (prop === HTMLLIElement.prototype) {
    // ä¿å­˜liå…ƒç´ 
    lList.push(elem);
    for (let i = 0; i < elem.children.length; i++) {
      let cur = elem.children[i];
      if (cur.__proto__ === HTMLAnchorElement.prototype) {
        if (autoNumber) {
          cur.text =  deep + ' ' + cur.text;
        }
      } else if (cur.__proto__ === HTMLUListElement.prototype) {
        addTocNumber(cur, deep);
      }
    }
  }
}


document.addEventListener('scroll', function(e) {
  if (lList.length <= 0) {
    return;
  }
  let scrollTop = document.scrollingElement.scrollTop + 10;
  let dir;

  if (lastTop - scrollTop > 0) {
    dir = 'up';
  } else {
    dir = 'down';
  }

  lastTop = scrollTop;
  if (scrollTop <= 0) {
    if (lastIndex >= 0 && lastIndex < hList.length) {
      lList[lastIndex].classList.remove(activeClass);
    }
    return;
  }

  let current = 0, hasFind = false;
  for (let i = 0; i < hList.length; i++) {
    if (hList[i].offsetTop > scrollTop) {
      current = i;
      hasFind = true;
      break;
    }
  }
  if (!hasFind && scrollTop > lList[lList.length - 1].offsetTop) {
    current = hList.length - 1;
  } else {
    current--;
  }
  if (dir === 'down') {
    if (current > lastIndex) {
      addActiveClass(current);
      removeActiveClass(lastIndex) 
      lastIndex = current;
      removeParentActiveClass();
      lList[current] && addActiveLiElemment(lList[current].parentElement,tocContent);
    }
  } else {
    if (current < lastIndex) {
      addActiveClass(current);
      removeActiveClass(lastIndex);
      lastIndex = current;
      removeParentActiveClass();
      lList[current] && addActiveLiElemment(lList[current].parentElement,tocContent);
    }
  }
});

function removeParentActiveClass() {
  let parents = tocContent.querySelectorAll('.'+active)
  parents.forEach(function(elem) {
    elem.classList.remove(active);
  });
}

function addActiveClass(index) {
  if (index >= 0 && index < hList.length) {
    lList[index].classList.add(activeClass);
  }
}

function removeActiveClass(index) {
  if (index >= 0 && index < hList.length) {
    lList[index].classList.remove(activeClass);
  }
}

function addActiveLiElemment(elem, parent) {
  if (!elem || elem === parent) {
    return;
  } else {
    if (elem.__proto__ === HTMLLIElement.prototype) {
      elem.classList.add(active);
    }
    addActiveLiElemment(elem.parentElement, parent);
  }
}

function showToc() {
  if (tocWrapper) {
    postBody = document.querySelector('#post_body');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        hList.push(postBody.children[i]);
      }
    }
    if (tocWrapper.classList.contains('compress')) {
        tocContent.classList.add('closed');
    } else if (tocWrapper.classList.contains('no_compress')){
      tocContent.classList.add('expanded');
    } else {
      if (hList.length > 10) {
        active = 'active-hidden'
        tocContent.classList.add('closed');
      } else {
        tocContent.classList.add('expanded');
      }
    }
  }
}
addTocNumber(tocContent, '');

window.addEventListener('load', function() {
  showToc();
  document.querySelector('#sidebar').style='display: block;';
  tocWrapper.classList.add('toc-active');
  setTimeout(function() {
    if ("createEvent" in document) {
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("scroll", false, true);
      document.dispatchEvent(evt);
    }
    else {
      document.fireEvent("scroll");
    }
  }, 500)
})

</script>
            </div>
          
        
      </div>
    </div>
  
</div>
<script>
  const SIDEBAR_TITLE_ACTIVE = 'sidebar-title-active';
  const SIDEBAR_BODY_ACTIVE = 'sidebar-body-active';
  const SLIDE_UP_IN = 'slide-up-in';

  let sidebar = document.querySelector('#sidebar'),
  tocSideBar = document.querySelector('#tocSideBar'),
  metaSideBar = document.querySelector('#metaSideBar'),
  postToc = document.querySelector('#post_toc'),
  postSiteMeta = document.querySelector('#post_side_meta'),
  sidebarTitle = document.querySelector('.sidebar-title'),
  sidebarBody = document.querySelector('#sidebar_body');

  tocSideBar && tocSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  metaSideBar && metaSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  function toggleSidebar(e) {
    let currentTitle = document.querySelector("."+SIDEBAR_TITLE_ACTIVE);
    if (currentTitle == e.srcElement) {
      return ;
    }
    let current, showElement, hideElement;
    if (e.srcElement == metaSideBar) {
      showElement = postSiteMeta;
      hideElement = postToc;
    } else if (e.srcElement == tocSideBar){
      showElement = postToc;
      hideElement = postSiteMeta;
    }
    currentTitle.classList.remove(SIDEBAR_TITLE_ACTIVE);
    e.srcElement.classList.add(SIDEBAR_TITLE_ACTIVE);

    window.Velocity(hideElement, 'stop');
    window.Velocity(hideElement, 'transition.slideUpOut', {
      display: 'none',
      duration: 200,
      complete: function () {
        window.Velocity(showElement, 'transition.slideDownIn', {
          duration: 200
        });
      }
    })
    hideElement.classList.remove(SIDEBAR_BODY_ACTIVE);
    showElement.classList.add(SIDEBAR_BODY_ACTIVE);
  }

  postToc && postToc.addEventListener('transitionend', function() {
    this.classList.remove(SLIDE_UP_IN);
  });

  if (sidebarBody) {
    if (sidebarBody.classList.contains('pisces') || sidebarBody.classList.contains('gemini')) {
      let hasFix = false;
      let scrollEl = document.querySelector('.main-continer');
      let limitTop = document.querySelector('#nav_ul').children.length * 42 + 162;
      window.addEventListener('scroll', function(e) {
        if (document.scrollingElement.scrollTop >= limitTop) {
          if (!hasFix) {
            sidebar.classList.add('sidebar-fixed');
            hasFix = true;
          }
        } else {
          if (hasFix) {
            sidebar.classList.remove('sidebar-fixed');
            hasFix = false;
          }
        }
      });
    }
  }
  
</script>
          <div class="section-box box-shadow-wrapper">
            <div class="section bg-color post post-page">
              <header class="post-header">
  <h1 class="post-title">
    <a class="post-title-link" href="https://yeming.site/post/redis-tao-tai-ji-zhi">
      Redisæ·˜æ±°æœºåˆ¶
    </a>
  </h1>
  <div class="post-meta">
    
    <span class="meta-item pc-show">
      <i class="fa fa-calendar-o"></i>
      <span>å‘å¸ƒäº</span>
      <span>2019-12-05</span>
      <span class="post-meta-divider pc-show">|</span>
    </span>
    
      <span class="meta-item">
        <i class="fa fa-folder-o"></i>
        <span class="pc-show">åˆ†ç±»äº</span>
        
          
            <a href="https://yeming.site/tag/redis">
              <span>Redis</span>
            </a>
          
        
      </span>
      <span class="post-meta-divider">|</span>
    
    <span class="meta-item">
      <i class="fa fa-clock-o"></i>
      <span>11åˆ†é’Ÿ</span>
    </span>
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-file-word-o"></i>
      <span>2751<span class="pc-show">å­—æ•°</span></span>
    </span>
    
      <span id="/post/redis-tao-tai-ji-zhi" class="meta-item pc-show leancloud_visitors">
        <span class="post-meta-divider">|</span>
        <i class="fa fa-eye"></i>
        <span>æµè§ˆé‡ï¼š<span class="leancloud-visitors-count" ></span></span>
      </span>
    
  </div>
</header>
              <div class="post-body next-md-body" id="post_body">
                <p>è¯´åˆ°Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œçªç„¶æˆ‘è”æƒ³åˆ°ä¹‹å‰ä¸Šå¤§å­¦æ—¶å€™çš„æ‰‹æœºå†…å­˜ä¸å¤Ÿç”¨çš„é—®é¢˜ã€‚è®°å¾—é‚£æ—¶å€™ä¹°çš„æ˜¯16Gçš„5sï¼ŒğŸæ‰‹æœºéƒ½çŸ¥é“ï¼Œéå¸¸è€ç”¨ï¼Œç”¨äº†å››å¹´éƒ½ä¸å¡ï¼Œæ‰€ä»¥æ‰‹æœºé‡Œå­˜äº†å¤§é‡çš„ä¸œè¥¿ï¼Œå¯¼è‡´æ‰‹æœºç»å¸¸æç¤ºå†…å­˜ä¸å¤Ÿç”¨ã€‚æˆ‘å°±ç»å¸¸åˆ é™¤æ‰‹æœºé‡Œçš„å›¾ç‰‡ï¼Œå½“æ—¶æˆ‘çš„ç­–ç•¥å°±æ˜¯å°†æ‰‹æœºé‡Œæœ€ä¸é‡è¦çš„ç…§ç‰‡ä»¥åŠå¾ˆå°‘ä¼šç”¨åˆ°çš„ç…§ç‰‡åˆ é™¤æ‰ï¼Œç°åœ¨æƒ³æƒ³å½“åˆä¹°æ‰‹æœºçš„æ—¶å€™çœŸåº”è¯¥ä¹°å†…å­˜å¤§ä¸€äº›çš„äº†ã€‚å…¶å®è¿™é‡Œæˆ‘åˆ é™¤æ‰‹æœºç…§ç‰‡çš„æ€è€ƒæ–¹å¼å°±æœ‰ç‚¹ç±»ä¼¼Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶äº†ã€‚</p>
<h1 id="åˆ é™¤ç­–ç•¥">åˆ é™¤ç­–ç•¥</h1>
<ul>
<li>å®šæ—¶åˆ é™¤:åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ timer). è®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸ æ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œã€‚</li>
<li>æƒ°æ€§åˆ é™¤:æ”¾ä»»é”®è¿‡æœŸä¸ç®¡ï¼Œä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶ï¼Œéƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡ æœŸï¼Œå¦‚æœè¿‡æœŸçš„è¯ï¼Œå°±åˆ é™¤è¯¥é”®;å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œå°±è¿”å›è¯¥é”®ã€‚</li>
<li>å®šæœŸåˆ é™¤:æ¯éš”ä¸€æ®µæ—¶é—´ç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®ã€‚è‡³äºè¦ åˆ é™¤å¤šå°‘è¿‡æœŸé”®ï¼Œä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“ï¼Œåˆ™ç”±ç®—æ³•å†³å®šã€‚</li>
</ul>
<h1 id="æ·˜æ±°ç­–ç•¥">æ·˜æ±°ç­–ç•¥</h1>
<p>Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶å°±æ˜¯ä¸ºäº†æ·˜æ±°æ‰ä¸€äº›æ•°æ®ï¼Œä¿è¯Redisçš„æ­£å¸¸æœåŠ¡ã€‚å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ maxmemery-policyé€‰æ‹©ä¸åŒçš„æ·˜æ±°ç­–ç•¥ï¼Œå…·ä½“çš„ç­–ç•¥æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>noeviction ä¸è¿›è¡Œä»»ä½•æ·˜æ±°æ“ä½œï¼Œå½“å†…å­˜ä¸å¤Ÿæ—¶å†™å‘½ä»¤ä¼šæŠ¥é”™</li>
<li>allkeys-lru åœ¨æ‰€æœ‰çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>æœ€å°‘ä½¿ç”¨</strong>çš„keyè¿›è¡Œæ·˜æ±°</li>
<li>volatile-lru åœ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>æœ€å°‘ä½¿ç”¨</strong>çš„keyè¿›è¡Œæ·˜æ±°</li>
<li>allkeys-random åœ¨æ‰€æœ‰çš„keyä¸­éšæœºç§»é™¤æŸä¸ªkey</li>
<li>volatile-random åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­éšæœºç§»é™¤æŸä¸ªkey</li>
<li>volatile-ttl åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œåˆ é™¤è¿‡æœŸæ—¶é—´æœ€æ—©çš„key</li>
<li>allkeys-lfu åœ¨æ‰€æœ‰çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>è®¿é—®é¢‘ç‡æœ€ä½</strong>çš„keyè¿›è¡Œæ·˜æ±°ï¼ˆ4.0ç‰ˆæœ¬ï¼‰</li>
<li>volatile-lfu åœ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>è®¿é—®é¢‘ç‡æœ€ä½</strong>çš„keyè¿›è¡Œæ·˜æ±°ï¼ˆ4.0ç‰ˆæœ¬ï¼‰</li>
</ul>
<p><strong>å¤‡æ³¨</strong><br>
è¿™é‡Œåˆ é™¤çš„keyå…¶å®åªåˆ é™¤ä¸€ä¸ªï¼Œè¿™æ˜¯å› ä¸ºRedisåœ¨æ‰§è¡Œå…·æœ‰ç”³è¯·å†…å­˜çš„å‘½ä»¤æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­å†…å­˜æ˜¯å¦è¶…è¿‡maxmemeryï¼Œå¦‚æœè¶…è¿‡äº†å°±ä¼šåŸºäºè®¾ç½®çš„maxmemery-policyç­–ç•¥åˆ é™¤keyã€‚</p>
<!-- more -->
<h1 id="lruç®—æ³•">LRUç®—æ³•</h1>
<p>LRUï¼ˆLeast Recently Usedï¼‰ç®—æ³•ï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨ä½¿ç”¨ç­–ç•¥ï¼Œæ·˜æ±°æ‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyã€‚æƒ³è¦å®ç°LRUç®—æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸ºæ¯ä¸ªkeyæ·»åŠ ä¸€ä¸ªæœ€è¿‘ä½¿ç”¨æ—¶é—´ï¼Œåœ¨å†…å­˜è¾¾åˆ°ä¸Šé™åï¼Œæ·»åŠ æ–°çš„keyæ—¶éå†æ‰€æœ‰keyå‰”é™¤ç©ºé—²æ—¶é—´(idle time)æœ€å¤§çš„ï¼Œè®¿é—®é¢‘ç‡æœ€ä½çš„å¯ä»¥ã€‚æˆ–è€…å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå°†æ‰€æœ‰çš„keyæ”¾è¿›ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¦‚æœè¾¾åˆ°å†…å­˜ä¸Šçº¿ï¼Œåªéœ€è¦å°†é˜Ÿå°¾çš„keyå‰”é™¤å°±è¡Œäº†ã€‚</p>
<blockquote>
<p>ä¸è®ºæ˜¯ä¸Šè¿°çš„å“ªç§å®ç°æ–¹å¼ï¼Œå¦‚æœç›´æ¥è¿ç”¨åœ¨Redisä¸­ï¼Œéƒ½ä¼šå½±å“æ€§èƒ½ï¼Œè¿™æ˜¾ç„¶ä¸Redisçš„é«˜æ€§èƒ½ç›¸æ‚–ã€‚æ‰€ä»¥Redisä¸­é‡‡ç”¨æ˜¯ä¸€ç§è¿‘ä¼¼LRUç®—æ³•ã€‚</p>
</blockquote>
<h2 id="lruç®—æ³•ç”±æ¥">lruç®—æ³•ç”±æ¥</h2>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†åˆ«æœ‰å››ä¸ªkeyï¼Œ~ä»£è¡¨1ç§’çš„æ—¶é—´é—´éš”ï¼Œç¬¬ä¸€æ¡çº¿Aä¸ºäº”ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç¬¬äºŒæ¡çº¿Bä¸º2ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç¬¬ä¸‰æ¡çº¿Cä¸º10ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç¬¬å››æ¡çº¿DåŒæ ·ä¸º10ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œåªä¸è¿‡å’ŒCèµ·å§‹æ—¶é—´ç‚¹ä¸ä¸€æ ·ã€‚|è¡¨ç¤ºåŒä¸€æ—¶é—´ç‚¹ï¼Œlruç®—æ³•åœ¨ç½®æ¢keyçš„æ—¶å€™ä¼šå‰”é™¤ç©ºé—²æ—¶é—´æœ€å¤§çš„keyã€‚æ ¹æ®lruç®—æ³•çš„åŸç†å¾—çŸ¥ï¼Œåœ¨|æ—¶åˆ»ï¼ŒDçš„ç©ºé—²æ—¶é—´(idle time)æ˜¯æœ€å°çš„ï¼Œä»£è¡¨ä¸‹ä¸€æ¬¡æœ€æœ‰å¯èƒ½è®¿é—®çš„keyæ˜¯Dï¼Œä½†æ˜¯ä»æ•´ä½“ä¸Šæ¥çœ‹Bæ˜¯å³å°†è®¿é—®çš„keyï¼Œè™½ç„¶è¿™ç§æƒ…å†µä¸‹lruç®—æ³•ä¼šå‡ºç°missæƒ…å†µï¼Œä½†æ˜¯åœ¨ç»å¤§å¤šæ•°çš„æƒ…å†µä¸‹è¿˜æ˜¯å¯ä»¥æŒ‰ç…§æœŸæœ›è¿è¡Œçš„ã€‚</p>
<blockquote>
<p>è¿™é‡Œä¸ºä»€ä¹ˆä¼šç”¨åˆ°ç½®æ¢ä¸€æ¬¡å‘¢ï¼Œä¸»è¦å°±æ˜¯åªæœ‰åœ¨æ–°çš„keyå†™å…¥å¹¶ä¸”å†…å­˜è¾¾åˆ°ä¸Šçº¿çš„æ—¶å€™æ‰ä¼šå‡ºç°å‰”é™¤æ—§çš„keyï¼Œæ‰€ä»¥ç½®æ¢ä¸€æ¬¡å°±æ˜¯ç”¨æ–°çš„keyæ›¿æ¢æ—§çš„keyã€‚</p>
</blockquote>
<pre><code class="language-java">~~~~~A~~~~~A~~~~~A~~~~A~~~~~A~~~~~A~~|
~~B~~B~~B~~B~~B~~B~~B~~B~~B~~B~~B~~B~|
~~~~~~~~~~C~~~~~~~~~C~~~~~~~~~C~~~~~~|
~~~~~D~~~~~~~~~~D~~~~~~~~~D~~~~~~~~~D|
</code></pre>
<h2 id="ä¸ºä»€ä¹ˆé‡‡ç”¨è¿‘ä¼¼çš„lruç®—æ³•">ä¸ºä»€ä¹ˆé‡‡ç”¨è¿‘ä¼¼çš„LRUç®—æ³•</h2>
<p>redisä¸­ä½¿ç”¨çš„LRUç®—æ³•å¹¶ä¸æ˜¯çœŸæ­£çš„LRUç®—æ³•ï¼Œé‡‡ç”¨çš„æ˜¯ä¸€ç§è¿‘ä¼¼çš„LRUç®—æ³•ï¼Œå¦‚æœæ¯æ¬¡æ·»åŠ keyçš„æ—¶å€™æŸ¥æ‰¾æ‰€æœ‰keyçš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œæ˜¾ç„¶åœ¨æ€§èƒ½ä¸Šä¼šæœ‰æ‰€é™ä½ï¼Œæœ¬æ¥è¿™ç§å‰”é™¤çš„ç­–ç•¥å°±æ˜¯ä¸€ç§æ¦‚ç‡çš„çŒœæµ‹ï¼Œæ‰€ä»¥åœ¨é€‰æ‹©æœ€å¤§çš„ç©ºé—²æ—¶é—´keyçš„æ—¶å€™ï¼Œåªè¦åœ¨æ¦‚ç‡ä¸Šé€¼è¿‘çœŸæ­£lruç®—æ³•å°±è¡Œäº†ã€‚è¿‡æœŸç®—æ³•æ˜¯åœ¨redis2.8ç‰ˆæœ¬ä¸­åŠ å…¥çš„ï¼Œå¹¶ä¸”åœ¨3.0ä¸­å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p>
<p>ä¸‹å›¾å¯¹lruç®—æ³•è¿›è¡Œäº†ä¸€äº›æ¯”è¾ƒï¼Œå·¦ä¸Šè§’æ˜¯ç†æƒ³çš„lruç®—æ³•æ•ˆæœã€‚ä¸Šå±‚æ˜¯æ”¹è¿›ç‰ˆå³3.0åçš„ç‰ˆæœ¬ä¸ç†æƒ³çš„lruç®—æ³•çš„ä¸€ä¸ªæ¯”è¾ƒï¼Œä¸‹é¢ä¸¤å¼ å›¾æ˜¯2.8ç‰ˆæœ¬ä¸3.0ç‰ˆæœ¬è¿›è¡Œçš„ä¸€ä¸ªæ¯”è¾ƒã€‚é‚£ä¹ˆéœ€è¦æ€ä¹ˆç†è§£è¿™ä¸ªå›¾å‘¢ï¼Ÿ<br>
<img src="https://yeming.site/post-images/1575603094713.png" alt="" loading="lazy"><br>
åœ¨è¿™ä¸ªå›¾é‡Œé¢åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸ</p>
<ul>
<li>æœ€ä¸Šå±‚çš„æµ…ç°è‰²åŒºåŸŸä»£è¡¨éœ€è¦æ·˜æ±°çš„key</li>
<li>ä¸­é—´å±‚æ·±ç°è‰²åŒºåŸŸä»£è¡¨æ˜¯æ—§çš„key</li>
<li>æœ€ä¸‹å±‚ç»¿è‰²çš„åŒºåŸŸä»£è¡¨çš„æ˜¯æ–°å¢çš„key</li>
</ul>
<p>åœ¨äº†è§£è¿™ä¸‰ä¸ªåŒºåŸŸä¹‹åï¼Œé‚£ä¹ˆæ€æ ·ç†è§£è¿™ä¸ªç®—æ³•å‘¢ï¼Œåœ¨æœ€ä¸Šå±‚åŒºåŸŸä¸­æ®‹ç•™çš„æ·±ç°è‰²ç‚¹è¡¨ç¤ºçš„æ˜¯æœªè¢«å‰”é™¤çš„æ·˜æ±°keyï¼Œæ·±ç°è‰²åŒºåŸŸç™½è‰²çš„ç‚¹æ˜¯è¢«å‰”é™¤æ‰çš„keyï¼Œä½†æ˜¯æœ¬æ¥ä¸åº”è¯¥è¢«å‰”é™¤æ‰ï¼ŒåŒç†ï¼Œæµ…ç»¿è‰²åŒºåŸŸç™½è‰²çš„ç‚¹ä¹Ÿæ˜¯ä»£è¡¨è¢«å‰”é™¤çš„keyã€‚lruç®—æ³•çš„å¥½åç¨‹åº¦å°±æ˜¯æ˜¯ä¸æ˜¯å‰”é™¤äº†éœ€è¦æ·˜æ±°çš„keyï¼Œåœ¨ä¸Šå›¾ä¸­å¯ä»¥çœ‹å­˜å‚¨redis3.0ç®—æ³•æ˜¯æœ€æ¥è¿‘ç†æƒ³çš„lruç®—æ³•æ•ˆæœã€‚</p>
<h2 id="redis30ä¸­å¯¹lruç®—æ³•çš„æ”¹è¿›">redis3.0ä¸­å¯¹lruç®—æ³•çš„æ”¹è¿›</h2>
<p>åœ¨æ¯æ¬¡éšæœºé€‰å–çš„keyï¼Œéƒ½ä¼šæ”¾è¿›ä¸€ä¸ªpoll(é»˜è®¤ä¸º16)ç¼“å­˜æ± ä¸­ï¼Œè¿™é‡Œé¢çš„keyæ˜¯æ ¹æ®æ¯ä¸ªkeyçš„ç©ºé—²æ—¶é—´å¤§å°æ’åºçš„ï¼Œæ¯æ¬¡éšæœºé€‰æ‹©çš„keyéƒ½éœ€è¦å’Œpollä¸­æœ€å°çš„keyè¿›è¡Œæ¯”è¾ƒï¼Œåªæœ‰å¤§äºæœ€å°çš„ç©ºé—²å€¼æ‰ä¼šè¢«æ”¾å…¥pollä¸­ï¼Œåœ¨æ¯æ¬¡å‰”é™¤keyçš„æ—¶å€™éƒ½ä¼šé€‰æ‹©ä¸€ä¸ªæœ€å¤§çš„ç©ºé—²å€¼æ¥å‰”é™¤ã€‚</p>
<p>ä¸€ä¸ªrediså®ä¾‹ä¸­ä¼šæœ‰å¤šä¸ªDBï¼Œå¯¹äºæ¯ä¸ªDBéƒ½ä¼šåˆ›å»ºä¸€ä¸ªpollæ·˜æ±°ç¼“å­˜ã€‚ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œå•ç‹¬æä¸€ä¸‹è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿåœ¨åé¢çš„LFUç®—æ³•ç”±æ¥ä¸­ä¼šè¯´é“ã€‚</p>
<h1 id="lfuç®—æ³•">LFUç®—æ³•</h1>
<p>å…¨ç§°Least Frequently Usedï¼Œä¸LRUä¸åŒçš„æ˜¯ï¼ŒLFUæ˜¯æŒ‰ç…§æ¯ä¸ªkeyè®¿é—®é¢‘ç‡è¿›è¡Œæ·˜æ±°çš„ï¼Œéšç€æ—¶é—´çš„å˜åŒ–ï¼Œæ¯ä¸ªkeyçš„è®¿é—®é¢‘ç‡ä¼šå‘ç”Ÿé€’å‡ã€‚</p>
<h2 id="ç”±æ¥">ç”±æ¥</h2>
<blockquote>
<p>Everything started from an open issue: when you have multiple databases<br>
with Redis 3.2, the algorithm evicts making local choices. So<br>
if for example you have all keys with a small idle time in DB number 0,<br>
and all keys with large idle time in DB number 1, Redis will evict<br>
one key from each DB. A more rational choice is of course to start<br>
evicting keys from DB number 1, and only later to evict the other keys.</p>
</blockquote>
<p>ä¸Šé¢æ˜¯æ¥è‡ªä½œè€…antireå†™<a href="http://antirez.com/news/109">lruç®—æ³•blog</a>ä¸­çš„ä¸€æ®µè¯ï¼Œè¿™æ®µè¯çš„æ„æ€æ˜¯å½“æœ‰ä¸¤ä¸ªDBæ—¶ï¼Œä¸€ä¸ªDBå…¨æ˜¯ç©ºé—²æ—¶é—´å°çš„keyï¼Œå¦ä¸€ä¸ªDBå…¨æ˜¯ç©ºé—²æ—¶é—´å¤§çš„keyï¼Œç„¶è€Œè¿™ä¸ªæ—¶å€™æ¯”è¾ƒçš„æ˜¯å„è‡ªDBä¸­çš„keyæ•°æ®ï¼Œå…¶å®åº”è¯¥å‰”é™¤çš„æ˜¯ç©ºé—²æ—¶é—´å¤§çš„DBã€‚åé¢ä½œè€…æåˆ°ï¼Œä¸ç®¡åœ¨lruçš„åŸºç¡€ä¸Šæ€ä¹ˆä¼˜åŒ–ï¼Œåœ¨æ€§èƒ½ä¸Šéƒ½æé«˜ä¸äº†ï¼Œæ‰€ä»¥ä½œè€…åé¢å°±å¼€å§‹ç ”ç©¶æ–°çš„ç®—æ³•å³LFUç®—æ³•ã€‚å…·ä½“ä½œè€…æ€ä¹ˆè¯´çš„å¯ä»¥å»çœ‹åŸæ–‡ï¼Œ<a href="http://antirez.com/news/109">åŸæ–‡é“¾æ¥</a>ã€‚</p>
<h2 id="è®¾è®¡æ–¹æ¡ˆ">è®¾è®¡æ–¹æ¡ˆ</h2>
<p>ä¸ºäº†å®ç°LFUæ–¹æ¡ˆï¼Œå°†LRUç®—æ³•ä¸­ä¸€ä¸ª24bitå­—æ®µ(ç”¨æ¥ä¿å­˜è®¿é—®æ—¶é—´çš„)æ‹†åˆ†æˆ16bitå’Œ8bitï¼Œåˆ†åˆ«ç”¨æ¥ä¿å­˜Last decr time(æœ€è¿‘é€’å‡æ—¶é—´)ä»¥åŠLOC_C(è®¿é—®æ¬¡æ•°)ã€‚</p>
<pre><code class="language-java">           16 bits      8 bits
      +----------------+--------+
      + Last decr time | LOG_C  |
      +----------------+--------+
</code></pre>
<h3 id="lfuè®¾è®¡æºç ">LFUè®¾è®¡æºç </h3>
<pre><code class="language-c">// LFUæ›´æ–°
void updateLFU(robj *val) {
    unsigned long counter = LFUDecrAndReturn(val);//é¦–å…ˆè®¡ç®—æ˜¯å¦éœ€è¦å°†counterè¡°å‡
    counter = LFULogIncr(counter);//æ ¹æ®ä¸Šè¿°è¿”å›çš„counterè®¡ç®—æ–°çš„counter
    val-&gt;lru = (LFUGetTimeInMinutes()&lt;&lt;8) | counter; //robjä¸­çš„lruå­—æ®µåªæœ‰24bits,lfuå¤ç”¨è¯¥å­—æ®µã€‚é«˜16ä½å­˜å‚¨ä¸€ä¸ªåˆ†é’Ÿæ•°çº§åˆ«çš„æ—¶é—´æˆ³ï¼Œä½8ä½å­˜å‚¨è®¿é—®è®¡æ•°
}
// counterå¢åŠ 
uint8_t LFULogIncr(uint8_t counter) {
    if (counter == 255) return 255;//counteræœ€å¤§åªèƒ½å­˜å‚¨åˆ°255,åˆ°è¾¾åä¸å†å¢åŠ 
    double r = (double)rand()/RAND_MAX;//ç®—ä¸€ä¸ªéšæœºçš„å°æ•°å€¼ï¼Œcounter++æ˜¯ä¸ªæ¦‚ç‡äº‹ä»¶ğŸ¤£
    double baseval = counter - LFU_INIT_VAL;//æ–°åŠ å…¥çš„keyåˆå§‹counterè®¾ç½®ä¸ºLFU_INIT_VAL,ä¸º5.ä¸è®¾ç½®ä¸º0çš„åŸå› æ˜¯é˜²æ­¢ç›´æ¥è¢«é€å‡º
    if (baseval &lt; 0) baseval = 0;
    double p = 1.0/(baseval*server.lfu_log_factor+1);//server.lfu_log_facotré»˜è®¤ä¸º10
    if (r &lt; p) counter++;//å¯ä»¥çœ‹åˆ°,counterè¶Šå¤§,åˆ™pè¶Šå°ï¼Œéšæœºå€¼rå°äºpçš„æ¦‚ç‡å°±è¶Šå°ã€‚æ¢è¨€ä¹‹,counterå¢åŠ èµ·æ¥ä¼šè¶Šæ¥è¶Šç¼“æ…¢
    return counter;
}
// counterè¡°å‡
unsigned long LFUDecrAndReturn(robj *o) {
    unsigned long ldt = o-&gt;lru &gt;&gt; 8;//åŸæ¥ä¿å­˜çš„æ—¶é—´æˆ³
    unsigned long counter = o-&gt;lru &amp; 255; //åŸæ¥ä¿å­˜çš„counter
    unsigned long num_periods = server.lfu_decay_time ? LFUTimeElapsed(ldt) / server.lfu_decay_time : 0;
    //server.lfu_decay_timeé»˜è®¤ä¸º1,æ¯ç»è¿‡ä¸€åˆ†é’Ÿcounterè¡°å‡1
    if (num_periods)
        counter = (num_periods &gt; counter) ? 0 : counter - num_periods;//å¦‚æœéœ€è¦è¡°å‡,åˆ™è®¡ç®—è¡°å‡åçš„å€¼
    return counter;
}
// è·å–åˆ†çº§åˆ«çš„æ—¶é—´
unsigned long LFUGetTimeInMinutes(void) {
    return (server.unixtime/60) &amp; 65535;//è·å–åˆ†é’Ÿçº§åˆ«çš„æ—¶é—´æˆ³
}
</code></pre>
<p>æƒ³è¦äº†è§£LFUç®—æ³•ï¼Œä¸€å®šè¦å…ˆçœ‹è¿™æ®µæºç ï¼Œè¿™æ®µæ‘˜è‡ª<a href="https://segmentfault.com/a/1190000017555834">æ€å¦çš„ä¸€ç¯‡æ–‡ç« </a>ï¼ˆå°Šé‡åŸåˆ›ï¼‰ã€‚</p>
<blockquote>
<p>ç½‘ä¸Šå¾ˆå¤šè¿™æ®µä»£ç çš„æ³¨é‡Šï¼Œè‡³äºè°æ˜¯åŸè‘—ä¸å¤ªäº†è§£ï¼Œåœ¨è¿™é‡Œæˆ‘æŠŠå­¦ä¹ æ—¶çœ‹åˆ°çš„åŸæ–‡æ”¾ä¸Šå»ã€‚</p>
</blockquote>
<ol>
<li>counteræ›´æ–°<br>
æ›´æ–°çš„æ–¹æ³•ä¸­ä¸»è¦æœ‰ä¸‰è¡Œä»£ç ï¼Œç¬¬ä¸€è¡Œä»£ç åˆ¤æ–­counteræ˜¯å¦éœ€è¦é€’å‡ï¼Œç¬¬äºŒè¡Œå¯¹counterè¿›è¡Œå¢åŠ ï¼Œç¬¬ä¸‰è¡Œï¼Œæ›´æ–°counterä»¥åŠæœ€æ–°çš„æ—¶é—´ã€‚</li>
<li>counterè¡°å‡</li>
<li>counterå¢åŠ <br>
åœ¨çœ‹æºç çš„æ—¶å€™å¯¹äºéšæœºå€¼pä¸æ˜¯å¤ªç†è§£ï¼Œçœ‹åˆ°æ³¨é‡Šçš„æ—¶å€™æ‰æ˜ç™½ï¼ŒåŸæ¥counterå€¼çš„å¢åŠ ä¹Ÿæ˜¯ä¸€ä¸ªæ¦‚ç‡äº‹ä»¶ï¼Œå½“counterè¶Šæ¥è¶Šå¤§çš„æ—¶å€™å‘ç”Ÿ++çš„æ¦‚ç‡å°±è¶Šå°ã€‚</li>
</ol>
<h2 id="lru-lfuç®—æ³•æµ‹è¯•">lruã€lfuç®—æ³•æµ‹è¯•</h2>
<p>rediså®˜æ–¹æä¾›äº†ä¸€ä¸ªæµ‹è¯•å·¥å…·æ¥æµ‹è¯•lruç®—æ³•ä»¥åŠlfuç®—æ³•çš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æµ‹è¯•çš„ç»“æœäº†è§£lfuç®—æ³•å¸¦æ¥çš„æ•ˆæœä¼˜åŒ–ã€‚</p>
<ol>
<li>config set maxmemory 50m</li>
<li>config set maxmemory-policy allkeys-lru</li>
<li>./redis-cli -p 6380 --lru-test 1000000</li>
<li>info æŸ¥çœ‹æ·˜æ±°ç­–ç•¥å…·ä½“è¿‡ç¨‹</li>
</ol>
<blockquote>
<p>å»ºè®®è‡ªå·±æ“ä½œä¸‹lruç®—æ³•å’Œlfuç®—æ³•ï¼Œæ¯”å¯¹æµ‹è¯•ç»“æœã€‚è¿™é‡Œçš„æµ‹è¯•å‘½ä»¤å¥½åƒåªæœ‰lru-testï¼Œä¸å­˜åœ¨lfu-testğŸ˜§ã€‚</p>
</blockquote>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<ol>
<li><a href="http://antirez.com/news/109">reidsä½œè€…å…³äºLRUç®—æ³•çš„è®²è§£</a></li>
<li><a href="https://segmentfault.com/a/1190000017555834">redisæºç åˆ†æ</a></li>
</ol>

              </div>
              <div class="post-footer">
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
      Madara
    </li>
    <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://yeming.site/post/redis-tao-tai-ji-zhi" title="Redisæ·˜æ±°æœºåˆ¶">Redisæ·˜æ±°æœºåˆ¶</a>
    </li>
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
      æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>
  <div class="tags">
    
      <a href="https://yeming.site/tag/redis"># Redis</a>
    
  </div>
  <div class="nav">
    <div class="nav-prev">
      
        <i class="fa fa-chevron-left"></i>
        <a class="nav-pc-next" title="æ¶ˆæ¯é˜Ÿåˆ—å­¦ä¹ å¼€ç¯‡" href="https://yeming.site/post/xiao-xi-dui-lie-xue-xi-kai-pian">æ¶ˆæ¯é˜Ÿåˆ—å­¦ä¹ å¼€ç¯‡</a class="nav-pc-next">
        <a class="nav-mobile-prev" title="æ¶ˆæ¯é˜Ÿåˆ—å­¦ä¹ å¼€ç¯‡" href="https://yeming.site/post/xiao-xi-dui-lie-xue-xi-kai-pian">ä¸Šä¸€ç¯‡</a>
      
    </div>
    <div class="nav-next">
      
        <a class="nav-pc-next" title="Vimå‘½ä»¤" href="https://yeming.site/post/vim-ming-ling-ji-lu">Vimå‘½ä»¤</a>
        <a class="nav-mobile-next" title="Vimå‘½ä»¤" href="https://yeming.site/post/vim-ming-ling-ji-lu">ä¸‹ä¸€ç¯‡</a>
        <i class="fa fa-chevron-right"></i>
      
    </div>
  </div>
</div>
              
                
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>
<div id="vcomments" style="padding: 10px 0px 0px 0px"></div>
<script>
new Valine({
    el: '#vcomments' ,
    appId: 'MudG5LjoytmIhsrwdEXPzp2y-gzGzoHsz',
    appKey: 'TLzYWUI2DEK7cnCkkmjbn1Ih',
    notify: 'true' === 'false', 
    avatar:'monsterid', 
    placeholder: 'Just Go',
    pageSize: '',
    lang: 'zh-cn',
    visitor: 'true' === 'true',
    highlight: 'true' === 'normal',
    avatarForce: 'true' === 'true',
});
</script>
              
            </div>
          </div>
        </div>
      </div>
      <div class="footer-box">
  <footer class="footer">
    <div class="copyright">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | Â© 2019-2020 Theme By HsxyHao
    </div>
    <div class="poweredby">
      
    </div>
  </footer>
  
  
  <div class="gemini back-to-top" id="back_to_top">
    <i class="fa fa-arrow-up"></i>
    
    <span class="scrollpercent">
      <span id="back_to_top_text">0</span>%
    </span>
    
  </div>
  
    <div class="bg-img">
      <img src="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/images/custom-bgImg.jpg" />
    </div>
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/live2d/histoire/css/live2d.css" />
<div class="box-scale">
  <div id="landlord" style="left:5px;bottom:0px;" data-key="8ebc03532fec488891b029035402984b">
    <div class="message" style="opacity:0"></div>
    <canvas id="live2d" width="500" height="560" class="live2d"></canvas>
    <div class="live_talk_input_body">
      <div class="live_talk_input_name_body">
        <input name="name" type="text" class="live_talk_name white_input" id="AIuserName" autocomplete="off" placeholder="ä½ çš„åå­—" />
      </div>
      <div class="live_talk_input_text_body">
        <input name="talk" type="text" class="live_talk_talk white_input" id="AIuserText" autocomplete="off" placeholder="è¦å’Œæˆ‘èŠä»€ä¹ˆå‘€ï¼Ÿ"/>
        <button type="button" class="live_talk_send_btn" id="talk_send">å‘é€</button>
      </div>
    </div>
    <input name="live_talk" id="live_talk" value="1" type="hidden" />
    <div class="live_ico_box">
      <div class="live_ico_item type_info" id="showInfoBtn"></div>
      <div class="live_ico_item type_talk" id="showTalkBtn"></div>
      
      <div class="live_ico_item type_music" id="musicButton"></div>
      
      <div class="live_ico_item type_youdu" id="youduButton"></div>
      <div class="live_ico_item type_quit" id="hideButton"></div>
      <input name="live_statu_val" id="live_statu_val" value="0" type="hidden" />
      <audio src="" style="display:none;" id="live2d_bgm" data-bgm="0" preload="none"></audio>
      <input id="duType" value="douqilai" type="hidden">
      
        <input name="live2dBGM" value="http://jaymusic.gitee.io/jaymusic33/003xv4w313tZHV.mp3" type="hidden">
      
    </div>
  </div>
</div>
<div id="open_live2d">å¬å”¤ä¼Šæ–¯ç‰¹ç“¦å°”</div>
<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
var message_Path = '/media/live2d/histoire/';
let landlord = document.querySelector('#landlord');
var apiKey = landlord.dataset.key;
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/live2d/histoire/js/live2d.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/live2d/histoire/js/message.js"></script>
  
  
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
  <div class="aplayer" id="aplayer"></div>
  <input hidden id="player_cover" value="/media/images/custom-cover.jpg" />
  <div class="music-list">
  
    
    <input hidden value="å…‰ã‚‹ãªã‚‰ ,Goose house,https://cn-south-17-aplayer-46154810.oss.dogecdn.com/hikarunara.mp3," />
  
  </div>
  <script>
  let musics = document.querySelector('.music-list').children;
  let mediaMusic = [];
  let cover = document.querySelector('#player_cover').value;
  for (let i = 0; i < musics.length; i++) {
    let item = musics[i];
    let splits = item.value.split(',');
    mediaMusic.push({
      name: splits[0],
      artist: splits[1],
      url: splits[2],
      lrc: splits[3],
      cover: cover
    });
  }
  console.log(mediaMusic);
  const ap = new APlayer({
      container: document.getElementById('aplayer'),
      fixed: true,
      lrcType: 3,
      listFolded: false,
      listMaxHeight: 90,
      audio: mediaMusic
  });
  </script>


  
</div>
<script>

  let sideBarOpen = 'sidebar-open';
  let body = document.body;
  let back2Top = document.querySelector('#back_to_top'),
  back2TopText = document.querySelector('#back_to_top_text'),
  drawerBox = document.querySelector('#drawer_box'),
  rightSideBar = document.querySelector('.sidebar'),
  viewport = document.querySelector('body');

  function scrollAnimation(currentY, targetY) {
   
    let needScrollTop = targetY - currentY
    let _currentY = currentY
    setTimeout(() => {
      const dist = Math.ceil(needScrollTop / 10)
      _currentY += dist
      window.scrollTo(_currentY, currentY)
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY)
      } else {
        window.scrollTo(_currentY, targetY)
      }
    }, 1)
  }

  back2Top.addEventListener("click", function(e) {
    scrollAnimation(document.scrollingElement.scrollTop, 0);
    e.stopPropagation();
    return false;
  });
  
  window.addEventListener('scroll', function(e) {
    let percent = document.scrollingElement.scrollTop / (document.scrollingElement.scrollHeight - document.scrollingElement.clientHeight) * 100;
    if (percent > 1 && !back2Top.classList.contains('back-top-active')) {
      back2Top.classList.add('back-top-active');
    }
    if (percent == 0) {
      back2Top.classList.remove('back-top-active');
    }
    if (back2TopText) {
      back2TopText.textContent = Math.floor(percent);
    }
  });

  
  let hasCacu = false;
  window.onresize = function() {
    if (window.width > 991) {
      calcuHeight();
    } else {
      hasCacu = false;
    }
  }

  function calcuHeight() {
    // åŠ¨æ€è°ƒæ•´ç«™ç‚¹æ¦‚è§ˆé«˜åº¦
    if (!hasCacu && back2Top.classList.contains('pisces') || back2Top.classList.contains('gemini')) {
      let sideBar = document.querySelector('.sidebar');
      let navUl = document.querySelector('#site_nav');
      sideBar.style = 'margin-top:' + (navUl.offsetHeight + navUl.offsetTop + 15) + 'px;';
      hasCacu = true;
    }
  }
  calcuHeight();
  
  let open = false, MOTION_TIME = 300, RIGHT_MOVE_DIS = '320px';

  if (drawerBox) {
    let rightMotions = document.querySelectorAll('.right-motion');
    let right = drawerBox.classList.contains('right');

    let transitionDir = right ? "transition.slideRightIn" : "transition.slideLeftIn";

    let openProp, closeProp;
    if (right) {
      openProp = {
        paddingRight: RIGHT_MOVE_DIS 
      };
      closeProp = {
        paddingRight: '0px'
      };
    } else {
      openProp = {
        paddingLeft: RIGHT_MOVE_DIS 
      };
      closeProp = {
        paddingLeft: '0px'
      };
    }

    drawerBox.onclick = function() {
      open = !open;
      window.Velocity(rightSideBar, 'stop');
      window.Velocity(viewport, 'stop');
      window.Velocity(rightMotions, 'stop');
      if (open) {
        window.Velocity(rightSideBar, {
          width: RIGHT_MOVE_DIS
        }, {
          duration: MOTION_TIME,
          begin: function() {
            window.Velocity(rightMotions, transitionDir,{ });
          }
        })
        window.Velocity(viewport, openProp,{
          duration: MOTION_TIME
        });
      } else {
        window.Velocity(rightSideBar, {
          width: '0px'
        }, {
          duration: MOTION_TIME,
          begin: function() {
            window.Velocity(rightMotions, {
              opacity: 0
            });
          }
        })
        window.Velocity(viewport, closeProp ,{
          duration: MOTION_TIME
        });
      }
      for (let i = 0; i < drawerBox.children.length; i++) {
        drawerBox.children[i].classList.toggle('muse-line');
      }
      drawerBox.classList.toggle(sideBarOpen);
    }
  }

  // ä»£ç é«˜äº®
  hljs.initHighlightingOnLoad();

</script>
    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/gh/hsxyhao/hsxyhao.github.io/media/js/motion.js"></script>
</html>