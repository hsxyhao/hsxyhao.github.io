<html>
  <head>
      <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Madara</title>
<link rel="shortcut icon" href="https://hsxyhao.github.io/favicon.ico?v=1576555466222">
<link rel="stylesheet" href="https://hsxyhao.github.io/styles/main.css">
<meta name="description" content="è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½ä¸æƒ³å†™..." />

<link rel="stylesheet" href="/media/fonts/iconfont.css">
<link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="head-top-line"></div>
    <div class="header-box">
      <header class="header">
  <div class="blog-header" id="header">
    <div class="site-meta">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-title slide-in">
        <a href="/" class="brand">
          <span>Madara</span>
        </a>
      </div>
      <p class="subtitle">Quick notes</p>
    </div>
    <nav class="site-nav" id="site_nav">
      <ul>
        <li class="nav-item ">
          
            
              
                <a href="/">
                  <i class="iconfont icon-home"></i> é¦–é¡µ
                </a>
              
            
          
            
          
            
          
            
          
        </li>
        <li class="nav-item ">
          
            
          
            
              
                <a href="/archives">
                  <i class="iconfont icon-archive"></i> å½’æ¡£
                </a>
              
            
          
            
          
            
          
        </li>
        <li class="nav-item ">
          
            
          
            
          
            
              
                <a href="/tags">
                  <i class="iconfont icon-tags"></i> æ ‡ç­¾
                </a>
              
            
          
            
          
        </li>
        <li class="nav-item">
          <a>
            <i class="iconfont icon-search"></i> æœç´¢
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>
<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function initEvent() {
    navToggle.addEventListener('click',navClick);
  }

  function navClick() {
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
  }

  window.addEventListener("load", initEvent);
  
</script>
    </div>
    <div class="main-continer">
      <div class="section-layout">
        <div class="section-layout-wrapper">
          
<div class="sidebar">
  <div class="sidebar-wrapper" id="sidebar">
    
      <div class="post-list-sidebar">
        <div class="sidebar-title">
          <span class="sidebar-title-item sidebar-title-active">æ–‡ç« ç›®å½•</span>
          <span class="sidebar-title-item">ç«™ç‚¹æ¦‚è§ˆ</span>
        </div>
      </div>
    
    <div class="post-sidebar-body">
      
        <div class="post-toc">
          <div class="toc-box">
  <div class="toc-wrapper" id="toc_wrapper">
    <ul class="markdownIt-TOC">
<li><a href="#%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5">æ·˜æ±°ç­–ç•¥</a></li>
<li><a href="#lru%E7%AE%97%E6%B3%95">LRUç®—æ³•</a>
<ul>
<li><a href="#lru%E7%AE%97%E6%B3%95%E7%94%B1%E6%9D%A5">lruç®—æ³•ç”±æ¥</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%87%87%E7%94%A8%E8%BF%91%E4%BC%BC%E7%9A%84lru%E7%AE%97%E6%B3%95">ä¸ºä»€ä¹ˆé‡‡ç”¨è¿‘ä¼¼çš„LRUç®—æ³•</a></li>
<li><a href="#redis30%E4%B8%AD%E5%AF%B9lru%E7%AE%97%E6%B3%95%E7%9A%84%E6%94%B9%E8%BF%9B">redis3.0ä¸­å¯¹lruç®—æ³•çš„æ”¹è¿›</a></li>
</ul>
</li>
<li><a href="#lfu%E7%AE%97%E6%B3%95">LFUç®—æ³•</a>
<ul>
<li><a href="#%E7%94%B1%E6%9D%A5">ç”±æ¥</a></li>
<li><a href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88">è®¾è®¡æ–¹æ¡ˆ</a>
<ul>
<li><a href="#lfu%E8%AE%BE%E8%AE%A1%E6%BA%90%E7%A0%81">LFUè®¾è®¡æºç </a></li>
</ul>
</li>
<li><a href="#lru-lfu%E7%AE%97%E6%B3%95%E6%B5%8B%E8%AF%95">lruã€lfuç®—æ³•æµ‹è¯•</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">å‚è€ƒé“¾æ¥</a></li>
</ul>

  </div>
</div>

<script>

let lastTop = 0, lList = [], hList = [], postBody, lastIndex = -1; 
let active = 'active-show', activeClass = 'active-current';
let tocWrapper = document.querySelector('#toc_wrapper');
let tocContent = tocWrapper.children[0];

function addTocNumber(elem, deep) {
  if (!elem) {
    return;
  }
  let prop = elem.__proto__;

  if (prop === HTMLUListElement.prototype) {
    for (let i = 0; i < elem.children.length; i++) {
      addTocNumber(elem.children[i], deep + (i + 1) + '.');
    }
  } else if (prop === HTMLLIElement.prototype) {
    // ä¿å­˜liå…ƒç´ 
    lList.push(elem);
    for (let i = 0; i < elem.children.length; i++) {
      let cur = elem.children[i];
      if (cur.__proto__ === HTMLAnchorElement.prototype) {
        cur.text =  deep + ' ' + cur.text;
      } else if (cur.__proto__ === HTMLUListElement.prototype) {
        addTocNumber(cur, deep);
      }
    }
  }
}


document.addEventListener('scroll', function(e) {
  let scrollTop = document.body.scrollTop;
  let dir;

  if (lastTop - scrollTop > 0) {
    dir = 'up';
  } else {
    dir = 'down';
  }

  lastTop = scrollTop;
  if (scrollTop <= 0) {
    if (lastIndex >= 0 && lastIndex < hList.length) {
      lList[lastIndex].classList.remove(activeClass);
      lastIndex = -1;
    }
    return;
  }

  let current = 0;
  for (let i = 0; i < hList.length; i++) {
    if (hList[i].offsetTop > scrollTop) {
      current = i;
      break;
    }
  }
  current--;
    if (dir === 'down') {
      if (current > lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex) 
        lastIndex = current;
        removeParentActiveClass();
        addActiveLiElemment(lList[current].parentElement,tocContent);
      }
    } else {
      if (current < lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex);
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement,tocContent);
      }
    }
});

function removeParentActiveClass() {
  let parents = tocContent.querySelectorAll('.'+active)
  parents.forEach(function(elem) {
    elem.classList.remove(active);
  });
}

function addActiveClass(index) {
  if (index >= 0 && index < hList.length) {
    lList[index].classList.add(activeClass);
  }
}

function removeActiveClass(index) {
  if (index >= 0 && index < hList.length) {
    lList[index].classList.remove(activeClass);
  }
}

function addActiveLiElemment(elem, parent) {
  if (!elem || elem === parent) {
    return;
  } else {
    if (elem.__proto__ === HTMLLIElement.prototype) {
      elem.classList.add(active);
    }
    addActiveLiElemment(elem.parentElement, parent);
  }
}

window.addEventListener('load', function() {
  if (tocWrapper) {
    postBody = document.querySelector('#post_body');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        hList.push(postBody.children[i]);
      }
    }

    if (hList.length > 10) {
      active = 'active-hidden'
      tocContent.classList.add('closed');
    } else {
      tocContent.classList.add('expanded');
    }

    if ("createEvent" in document) {
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("scroll", false, true);
      document.dispatchEvent(evt);
    }
    else {
      document.fireEvent("scroll");
    }
    addTocNumber(tocContent, '');
  }
  document.querySelector('#sidebar').style='display: block;';
  tocWrapper.classList.add('toc-active');
})



</script>
        </div>
        <div class="post-side-meta">
          <div class="sidebar-wrapper">
  <div class="sidebar-item">
    <img class="site-author-image" src="https://hsxyhao.github.io/images/avatar.png"/>
    <p class="site-author-name">Madara</p>
    <p class="site-description">è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½ä¸æƒ³å†™...</p>
  </div>
  <div class="sidebar-item side-item-stat">
    <div class="sidebar-item-box">
      <a href="/archives/">
        <span class="site-item-stat-count">8</span>
        <span class="site-item-stat-name">æ—¥å¿—</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="">
        <span class="site-item-stat-count">5</span>
        <span class="site-item-stat-name">åˆ†ç±»</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="/tags/">
        <span class="site-item-stat-count">5</span>
        <span class="site-item-stat-name">æ ‡ç­¾</span>
      </a>
    </div>
  </div>
  <div class="sidebar-item">
    <span class="site-item-rss">
        <i class="iconfont icon-rss"></i>
        <a href="https://hsxyhao.github.io/atom.xml" target="_blank">RSS</a>
    </span>
  </div>
  <div class="sidebar-item sidebar-item-social">
    <div class="social-item">
      <a href="https://www.github.com/hsxyhao">
        <i class="iconfont icon-github"></i> GitHub
      </a>
      <a href="">
        <i class="iconfont icon-twitter"></i> Twitter
      </a>
    </div>
    <div class="social-item">
      <a href="">
        <i class="iconfont icon-globe"></i> è±†ç“£
      </a>
      <a href="">
        <i class="iconfont icon-globe"></i> çŸ¥ä¹
      </a>
    </div>
  </div>
</div>
        </div>
      
    </div>
  </div>
</div>
<script>
  let sidebar = document.querySelector('#sidebar');
  let limitTop = sidebar.offsetTop;
  let hasFix = false;
  window.addEventListener('scroll', function(e) {
    if (document.body.scrollTop >= limitTop) {
      if (!hasFix) {
        sidebar.classList.add('sidebar-fixed');
        hasFix = true;
      }
    } else {
      if (hasFix) {
        sidebar.classList.remove('sidebar-fixed');
        hasFix = false;
      }
    }
  });
</script>
          <div class="section-box">
            <div class="section">
              <div class="article-box">
    <header class="post-header">
  <h1 class="post-title">
    <a class="post-title-link" href="https://hsxyhao.github.io/post/redis-tao-tai-ji-zhi">
      cæ·˜æ±°æœºåˆ¶
    </a>
  </h1>
  <div class="post-meta">
    <span class="meta-item">
      <i class="iconfont icon-calendar_empty"></i>
      <span class="pc-show">å‘å¸ƒäº</span>
      <span>2019-12-05</span>
    </span>
    
      <span class="meta-item">
        <span class="post-meta-divider">|</span>
        <i class="iconfont icon-folder_open_alt"></i>
        <span class="pc-show">åˆ†ç±»äº</span>
        
          
            <a href="https://hsxyhao.github.io/tag/Redis">
              <span>Redis</span>
            </a>
          
        
      </span>
    
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="iconfont icon-time"></i>
      <span>10åˆ†é’Ÿ</span>
    </span>
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="iconfont icon-keyboard"></i>
      <span class="pc-show">2582å­—æ•°</span>
    </span>
  </div>
</header>
</div>
              <div class="post-body next-md-body" id="post_body">
                <p>è¯´åˆ°Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œç„¶æˆ‘è”æƒ³åˆ°ä¹‹å‰ä¸Šå¤§å­¦æ—¶å€™çš„æ‰‹æœºå†…å­˜ä¸å¤Ÿç”¨çš„é—®é¢˜ã€‚è®°å¾—é‚£æ—¶å€™ä¹°çš„æ˜¯16Gçš„5sï¼ŒğŸæ‰‹æœºéƒ½çŸ¥é“ï¼Œéå¸¸è€ç”¨ï¼Œç”¨äº†å››å¹´éƒ½ä¸å¡ï¼Œæ‰€ä»¥æ‰‹æœºé‡Œå­˜äº†å¤§é‡çš„ä¸œè¥¿ï¼Œå¯¼è‡´æ‰‹æœºç»å¸¸æç¤ºå†…å­˜ä¸å¤Ÿç”¨ã€‚æˆ‘å°±ç»å¸¸åˆ é™¤æ‰‹æœºé‡Œçš„å›¾ç‰‡ï¼Œå½“æ—¶æˆ‘çš„ç­–ç•¥å°±æ˜¯å°†æ‰‹æœºé‡Œæœ€ä¸é‡è¦çš„ç…§ç‰‡ä»¥åŠå¾ˆå°‘ä¼šç”¨åˆ°çš„ç…§ç‰‡åˆ é™¤æ‰ï¼Œç°åœ¨æƒ³æƒ³å½“åˆä¹°æ‰‹æœºçš„æ—¶å€™çœŸåº”è¯¥ä¹°å†…å­˜å¤§ä¸€äº›çš„äº†ã€‚å…¶å®è¿™é‡Œæˆ‘åˆ é™¤æ‰‹æœºç…§ç‰‡çš„æ€è€ƒæ–¹å¼å°±æœ‰ç‚¹ç±»ä¼¼Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶äº†ã€‚</p>
<h1 id="æ·˜æ±°ç­–ç•¥">æ·˜æ±°ç­–ç•¥</h1>
<p>Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶å°±æ˜¯ä¸ºäº†æ·˜æ±°æ‰ä¸€äº›æ•°æ®ï¼Œä¿è¯Redisçš„æ­£å¸¸æœåŠ¡ã€‚å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ maxmemery-policyé€‰æ‹©ä¸åŒçš„æ·˜æ±°ç­–ç•¥ï¼Œå…·ä½“çš„ç­–ç•¥æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>noeviction ä¸è¿›è¡Œä»»ä½•æ·˜æ±°æ“ä½œï¼Œå½“å†…å­˜ä¸å¤Ÿæ—¶å†™å‘½ä»¤ä¼šæŠ¥é”™</li>
<li>allkeys-lru åœ¨æ‰€æœ‰çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>æœ€å°‘ä½¿ç”¨</strong>çš„keyè¿›è¡Œæ·˜æ±°</li>
<li>volatile-lru åœ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>æœ€å°‘ä½¿ç”¨</strong>çš„keyè¿›è¡Œæ·˜æ±°</li>
<li>allkeys-random åœ¨æ‰€æœ‰çš„keyä¸­éšæœºç§»é™¤æŸä¸ªkey</li>
<li>volatile-random åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­éšæœºç§»é™¤æŸä¸ªkey</li>
<li>volatile-ttl åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œåˆ é™¤è¿‡æœŸæ—¶é—´æœ€æ—©çš„key</li>
<li>allkeys-lfu åœ¨æ‰€æœ‰çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>è®¿é—®é¢‘ç‡æœ€ä½</strong>çš„keyè¿›è¡Œæ·˜æ±°ï¼ˆ4.0ç‰ˆæœ¬ï¼‰</li>
<li>volatile-lfu åœ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„keyä¸­æŸ¥æ‰¾æœ€è¿‘<strong>è®¿é—®é¢‘ç‡æœ€ä½</strong>çš„keyè¿›è¡Œæ·˜æ±°ï¼ˆ4.0ç‰ˆæœ¬ï¼‰</li>
</ul>
<p><strong>å¤‡æ³¨</strong><br>
è¿™é‡Œåˆ é™¤çš„keyå…¶å®åªåˆ é™¤ä¸€ä¸ªï¼Œè¿™æ˜¯å› ä¸ºRedisåœ¨æ‰§è¡Œå…·æœ‰ç”³è¯·å†…å­˜çš„å‘½ä»¤æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­å†…å­˜æ˜¯å¦è¶…è¿‡maxmemeryï¼Œå¦‚æœè¶…è¿‡äº†å°±ä¼šåŸºäºè®¾ç½®çš„maxmemery-policyç­–ç•¥åˆ é™¤keyã€‚</p>
<!-- more -->
<h1 id="lruç®—æ³•">LRUç®—æ³•</h1>
<p>LRUï¼ˆLeast Recently Usedï¼‰ç®—æ³•ï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨ä½¿ç”¨ç­–ç•¥ï¼Œæ·˜æ±°æ‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„keyã€‚æƒ³è¦å®ç°LRUç®—æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸ºæ¯ä¸ªkeyæ·»åŠ ä¸€ä¸ªæœ€è¿‘ä½¿ç”¨æ—¶é—´ï¼Œåœ¨å†…å­˜è¾¾åˆ°ä¸Šé™åï¼Œæ·»åŠ æ–°çš„keyæ—¶éå†æ‰€æœ‰keyå‰”é™¤ç©ºé—²æ—¶é—´(idle time)æœ€å¤§çš„ï¼Œè®¿é—®é¢‘ç‡æœ€ä½çš„å¯ä»¥ã€‚æˆ–è€…å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå°†æ‰€æœ‰çš„keyæ”¾è¿›ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¦‚æœè¾¾åˆ°å†…å­˜ä¸Šçº¿ï¼Œåªéœ€è¦å°†é˜Ÿå°¾çš„keyå‰”é™¤å°±è¡Œäº†ã€‚</p>
<blockquote>
<p>ä¸è®ºæ˜¯ä¸Šè¿°çš„å“ªç§å®ç°æ–¹å¼ï¼Œå¦‚æœç›´æ¥è¿ç”¨åœ¨Redisä¸­ï¼Œéƒ½ä¼šå½±å“æ€§èƒ½ï¼Œè¿™æ˜¾ç„¶ä¸Redisçš„é«˜æ€§èƒ½ç›¸æ‚–ã€‚æ‰€ä»¥Redisä¸­é‡‡ç”¨æ˜¯ä¸€ç§è¿‘ä¼¼LRUç®—æ³•ã€‚</p>
</blockquote>
<h2 id="lruç®—æ³•ç”±æ¥">lruç®—æ³•ç”±æ¥</h2>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†åˆ«æœ‰å››ä¸ªkeyï¼Œ~ä»£è¡¨1ç§’çš„æ—¶é—´é—´éš”ï¼Œç¬¬ä¸€æ¡çº¿Aä¸ºäº”ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç¬¬äºŒæ¡çº¿Bä¸º2ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç¬¬ä¸‰æ¡çº¿Cä¸º10ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç¬¬å››æ¡çº¿DåŒæ ·ä¸º10ç§’é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œåªä¸è¿‡å’ŒCèµ·å§‹æ—¶é—´ç‚¹ä¸ä¸€æ ·ã€‚|è¡¨ç¤ºåŒä¸€æ—¶é—´ç‚¹ï¼Œlruç®—æ³•åœ¨ç½®æ¢keyçš„æ—¶å€™ä¼šå‰”é™¤ç©ºé—²æ—¶é—´æœ€å¤§çš„keyã€‚æ ¹æ®lruç®—æ³•çš„åŸç†å¾—çŸ¥ï¼Œåœ¨|æ—¶åˆ»ï¼ŒDçš„ç©ºé—²æ—¶é—´(idle time)æ˜¯æœ€å°çš„ï¼Œä»£è¡¨ä¸‹ä¸€æ¬¡æœ€æœ‰å¯èƒ½è®¿é—®çš„keyæ˜¯Dï¼Œä½†æ˜¯ä»æ•´ä½“ä¸Šæ¥çœ‹Bæ˜¯å³å°†è®¿é—®çš„keyï¼Œè™½ç„¶è¿™ç§æƒ…å†µä¸‹lruç®—æ³•ä¼šå‡ºç°missæƒ…å†µï¼Œä½†æ˜¯åœ¨ç»å¤§å¤šæ•°çš„æƒ…å†µä¸‹è¿˜æ˜¯å¯ä»¥æŒ‰ç…§æœŸæœ›è¿è¡Œçš„ã€‚</p>
<blockquote>
<p>è¿™é‡Œä¸ºä»€ä¹ˆä¼šç”¨åˆ°ç½®æ¢ä¸€æ¬¡å‘¢ï¼Œä¸»è¦å°±æ˜¯åªæœ‰åœ¨æ–°çš„keyå†™å…¥å¹¶ä¸”å†…å­˜è¾¾åˆ°ä¸Šçº¿çš„æ—¶å€™æ‰ä¼šå‡ºç°å‰”é™¤æ—§çš„keyï¼Œæ‰€ä»¥ç½®æ¢ä¸€æ¬¡å°±æ˜¯ç”¨æ–°çš„keyæ›¿æ¢æ—§çš„keyã€‚</p>
</blockquote>
<pre><code class="language-java">~~~~~A~~~~~A~~~~~A~~~~A~~~~~A~~~~~A~~|
~~B~~B~~B~~B~~B~~B~~B~~B~~B~~B~~B~~B~|
~~~~~~~~~~C~~~~~~~~~C~~~~~~~~~C~~~~~~|
~~~~~D~~~~~~~~~~D~~~~~~~~~D~~~~~~~~~D|
</code></pre>
<h2 id="ä¸ºä»€ä¹ˆé‡‡ç”¨è¿‘ä¼¼çš„lruç®—æ³•">ä¸ºä»€ä¹ˆé‡‡ç”¨è¿‘ä¼¼çš„LRUç®—æ³•</h2>
<p>redisä¸­ä½¿ç”¨çš„LRUç®—æ³•å¹¶ä¸æ˜¯çœŸæ­£çš„LRUç®—æ³•ï¼Œé‡‡ç”¨çš„æ˜¯ä¸€ç§è¿‘ä¼¼çš„LRUç®—æ³•ï¼Œå¦‚æœæ¯æ¬¡æ·»åŠ keyçš„æ—¶å€™æŸ¥æ‰¾æ‰€æœ‰keyçš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œæ˜¾ç„¶åœ¨æ€§èƒ½ä¸Šä¼šæœ‰æ‰€é™ä½ï¼Œæœ¬æ¥è¿™ç§å‰”é™¤çš„ç­–ç•¥å°±æ˜¯ä¸€ç§æ¦‚ç‡çš„çŒœæµ‹ï¼Œæ‰€ä»¥åœ¨é€‰æ‹©æœ€å¤§çš„ç©ºé—²æ—¶é—´keyçš„æ—¶å€™ï¼Œåªè¦åœ¨æ¦‚ç‡ä¸Šé€¼è¿‘çœŸæ­£lruç®—æ³•å°±è¡Œäº†ã€‚è¿‡æœŸç®—æ³•æ˜¯åœ¨redis2.8ç‰ˆæœ¬ä¸­åŠ å…¥çš„ï¼Œå¹¶ä¸”åœ¨3.0ä¸­å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p>
<p>ä¸‹å›¾å¯¹lruç®—æ³•è¿›è¡Œäº†ä¸€äº›æ¯”è¾ƒï¼Œå·¦ä¸Šè§’æ˜¯ç†æƒ³çš„lruç®—æ³•æ•ˆæœã€‚ä¸Šå±‚æ˜¯æ”¹è¿›ç‰ˆå³3.0åçš„ç‰ˆæœ¬ä¸ç†æƒ³çš„lruç®—æ³•çš„ä¸€ä¸ªæ¯”è¾ƒï¼Œä¸‹é¢ä¸¤å¼ å›¾æ˜¯2.8ç‰ˆæœ¬ä¸3.0ç‰ˆæœ¬è¿›è¡Œçš„ä¸€ä¸ªæ¯”è¾ƒã€‚é‚£ä¹ˆéœ€è¦æ€ä¹ˆç†è§£è¿™ä¸ªå›¾å‘¢ï¼Ÿ<br>
<img src="https://hsxyhao.github.io/post-images/1575603094713.png" alt=""><br>
åœ¨è¿™ä¸ªå›¾é‡Œé¢åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸ</p>
<ul>
<li>æœ€ä¸Šå±‚çš„æµ…ç°è‰²åŒºåŸŸä»£è¡¨éœ€è¦æ·˜æ±°çš„key</li>
<li>ä¸­é—´å±‚æ·±ç°è‰²åŒºåŸŸä»£è¡¨æ˜¯æ—§çš„key</li>
<li>æœ€ä¸‹å±‚ç»¿è‰²çš„åŒºåŸŸä»£è¡¨çš„æ˜¯æ–°å¢çš„key</li>
</ul>
<p>åœ¨äº†è§£è¿™ä¸‰ä¸ªåŒºåŸŸä¹‹åï¼Œé‚£ä¹ˆæ€æ ·ç†è§£è¿™ä¸ªç®—æ³•å‘¢ï¼Œåœ¨æœ€ä¸Šå±‚åŒºåŸŸä¸­æ®‹ç•™çš„æ·±ç°è‰²ç‚¹è¡¨ç¤ºçš„æ˜¯æœªè¢«å‰”é™¤çš„æ·˜æ±°keyï¼Œæ·±ç°è‰²åŒºåŸŸç™½è‰²çš„ç‚¹æ˜¯è¢«å‰”é™¤æ‰çš„keyï¼Œä½†æ˜¯æœ¬æ¥ä¸åº”è¯¥è¢«å‰”é™¤æ‰ï¼ŒåŒç†ï¼Œæµ…ç»¿è‰²åŒºåŸŸç™½è‰²çš„ç‚¹ä¹Ÿæ˜¯ä»£è¡¨è¢«å‰”é™¤çš„keyã€‚lruç®—æ³•çš„å¥½åç¨‹åº¦å°±æ˜¯æ˜¯ä¸æ˜¯å‰”é™¤äº†éœ€è¦æ·˜æ±°çš„keyï¼Œåœ¨ä¸Šå›¾ä¸­å¯ä»¥çœ‹å­˜å‚¨redis3.0ç®—æ³•æ˜¯æœ€æ¥è¿‘ç†æƒ³çš„lruç®—æ³•æ•ˆæœã€‚</p>
<h2 id="redis30ä¸­å¯¹lruç®—æ³•çš„æ”¹è¿›">redis3.0ä¸­å¯¹lruç®—æ³•çš„æ”¹è¿›</h2>
<p>åœ¨æ¯æ¬¡éšæœºé€‰å–çš„keyï¼Œéƒ½ä¼šæ”¾è¿›ä¸€ä¸ªpoll(é»˜è®¤ä¸º16)ç¼“å­˜æ± ä¸­ï¼Œè¿™é‡Œé¢çš„keyæ˜¯æ ¹æ®æ¯ä¸ªkeyçš„ç©ºé—²æ—¶é—´å¤§å°æ’åºçš„ï¼Œæ¯æ¬¡éšæœºé€‰æ‹©çš„keyéƒ½éœ€è¦å’Œpollä¸­æœ€å°çš„keyè¿›è¡Œæ¯”è¾ƒï¼Œåªæœ‰å¤§äºæœ€å°çš„ç©ºé—²å€¼æ‰ä¼šè¢«æ”¾å…¥pollä¸­ï¼Œåœ¨æ¯æ¬¡å‰”é™¤keyçš„æ—¶å€™éƒ½ä¼šé€‰æ‹©ä¸€ä¸ªæœ€å¤§çš„ç©ºé—²å€¼æ¥å‰”é™¤ã€‚</p>
<p>ä¸€ä¸ªrediså®ä¾‹ä¸­ä¼šæœ‰å¤šä¸ªDBï¼Œå¯¹äºæ¯ä¸ªDBéƒ½ä¼šåˆ›å»ºä¸€ä¸ªpollæ·˜æ±°ç¼“å­˜ã€‚ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œå•ç‹¬æä¸€ä¸‹è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿåœ¨åé¢çš„LFUç®—æ³•ç”±æ¥ä¸­ä¼šè¯´é“ã€‚</p>
<h1 id="lfuç®—æ³•">LFUç®—æ³•</h1>
<p>å…¨ç§°Least Frequently Usedï¼Œä¸LRUä¸åŒçš„æ˜¯ï¼ŒLFUæ˜¯æŒ‰ç…§æ¯ä¸ªkeyè®¿é—®é¢‘ç‡è¿›è¡Œæ·˜æ±°çš„ï¼Œéšç€æ—¶é—´çš„å˜åŒ–ï¼Œæ¯ä¸ªkeyçš„è®¿é—®é¢‘ç‡ä¼šå‘ç”Ÿé€’å‡ã€‚</p>
<h2 id="ç”±æ¥">ç”±æ¥</h2>
<blockquote>
<p>Everything started from an open issue: when you have multiple databases<br>
with Redis 3.2, the algorithm evicts making local choices. So<br>
if for example you have all keys with a small idle time in DB number 0,<br>
and all keys with large idle time in DB number 1, Redis will evict<br>
one key from each DB. A more rational choice is of course to start<br>
evicting keys from DB number 1, and only later to evict the other keys.</p>
</blockquote>
<p>ä¸Šé¢æ˜¯æ¥è‡ªä½œè€…antireå†™<a href="http://antirez.com/news/109">lruç®—æ³•blog</a>ä¸­çš„ä¸€æ®µè¯ï¼Œè¿™æ®µè¯çš„æ„æ€æ˜¯å½“æœ‰ä¸¤ä¸ªDBæ—¶ï¼Œä¸€ä¸ªDBå…¨æ˜¯ç©ºé—²æ—¶é—´å°çš„keyï¼Œå¦ä¸€ä¸ªDBå…¨æ˜¯ç©ºé—²æ—¶é—´å¤§çš„keyï¼Œç„¶è€Œè¿™ä¸ªæ—¶å€™æ¯”è¾ƒçš„æ˜¯å„è‡ªDBä¸­çš„keyæ•°æ®ï¼Œå…¶å®åº”è¯¥å‰”é™¤çš„æ˜¯ç©ºé—²æ—¶é—´å¤§çš„DBã€‚åé¢ä½œè€…æåˆ°ï¼Œä¸ç®¡åœ¨lruçš„åŸºç¡€ä¸Šæ€ä¹ˆä¼˜åŒ–ï¼Œåœ¨æ€§èƒ½ä¸Šéƒ½æé«˜ä¸äº†ï¼Œæ‰€ä»¥ä½œè€…åé¢å°±å¼€å§‹ç ”ç©¶æ–°çš„ç®—æ³•å³LFUç®—æ³•ã€‚å…·ä½“ä½œè€…æ€ä¹ˆè¯´çš„å¯ä»¥å»çœ‹åŸæ–‡ï¼Œ<a href="http://antirez.com/news/109">åŸæ–‡é“¾æ¥</a>ã€‚</p>
<h2 id="è®¾è®¡æ–¹æ¡ˆ">è®¾è®¡æ–¹æ¡ˆ</h2>
<p>ä¸ºäº†å®ç°LFUæ–¹æ¡ˆï¼Œå°†LRUç®—æ³•ä¸­ä¸€ä¸ª24bitå­—æ®µ(ç”¨æ¥ä¿å­˜è®¿é—®æ—¶é—´çš„)æ‹†åˆ†æˆ16bitå’Œ8bitï¼Œåˆ†åˆ«ç”¨æ¥ä¿å­˜Last decr time(æœ€è¿‘é€’å‡æ—¶é—´)ä»¥åŠLOC_C(è®¿é—®æ¬¡æ•°)ã€‚</p>
<pre><code class="language-java">           16 bits      8 bits
      +----------------+--------+
      + Last decr time | LOG_C  |
      +----------------+--------+
</code></pre>
<h3 id="lfuè®¾è®¡æºç ">LFUè®¾è®¡æºç </h3>
<pre><code class="language-c">// LFUæ›´æ–°
void updateLFU(robj *val) {
    unsigned long counter = LFUDecrAndReturn(val);//é¦–å…ˆè®¡ç®—æ˜¯å¦éœ€è¦å°†counterè¡°å‡
    counter = LFULogIncr(counter);//æ ¹æ®ä¸Šè¿°è¿”å›çš„counterè®¡ç®—æ–°çš„counter
    val-&gt;lru = (LFUGetTimeInMinutes()&lt;&lt;8) | counter; //robjä¸­çš„lruå­—æ®µåªæœ‰24bits,lfuå¤ç”¨è¯¥å­—æ®µã€‚é«˜16ä½å­˜å‚¨ä¸€ä¸ªåˆ†é’Ÿæ•°çº§åˆ«çš„æ—¶é—´æˆ³ï¼Œä½8ä½å­˜å‚¨è®¿é—®è®¡æ•°
}
// counterå¢åŠ 
uint8_t LFULogIncr(uint8_t counter) {
    if (counter == 255) return 255;//counteræœ€å¤§åªèƒ½å­˜å‚¨åˆ°255,åˆ°è¾¾åä¸å†å¢åŠ 
    double r = (double)rand()/RAND_MAX;//ç®—ä¸€ä¸ªéšæœºçš„å°æ•°å€¼ï¼Œcounter++æ˜¯ä¸ªæ¦‚ç‡äº‹ä»¶ğŸ¤£
    double baseval = counter - LFU_INIT_VAL;//æ–°åŠ å…¥çš„keyåˆå§‹counterè®¾ç½®ä¸ºLFU_INIT_VAL,ä¸º5.ä¸è®¾ç½®ä¸º0çš„åŸå› æ˜¯é˜²æ­¢ç›´æ¥è¢«é€å‡º
    if (baseval &lt; 0) baseval = 0;
    double p = 1.0/(baseval*server.lfu_log_factor+1);//server.lfu_log_facotré»˜è®¤ä¸º10
    if (r &lt; p) counter++;//å¯ä»¥çœ‹åˆ°,counterè¶Šå¤§,åˆ™pè¶Šå°ï¼Œéšæœºå€¼rå°äºpçš„æ¦‚ç‡å°±è¶Šå°ã€‚æ¢è¨€ä¹‹,counterå¢åŠ èµ·æ¥ä¼šè¶Šæ¥è¶Šç¼“æ…¢
    return counter;
}
// counterè¡°å‡
unsigned long LFUDecrAndReturn(robj *o) {
    unsigned long ldt = o-&gt;lru &gt;&gt; 8;//åŸæ¥ä¿å­˜çš„æ—¶é—´æˆ³
    unsigned long counter = o-&gt;lru &amp; 255; //åŸæ¥ä¿å­˜çš„counter
    unsigned long num_periods = server.lfu_decay_time ? LFUTimeElapsed(ldt) / server.lfu_decay_time : 0;
    //server.lfu_decay_timeé»˜è®¤ä¸º1,æ¯ç»è¿‡ä¸€åˆ†é’Ÿcounterè¡°å‡1
    if (num_periods)
        counter = (num_periods &gt; counter) ? 0 : counter - num_periods;//å¦‚æœéœ€è¦è¡°å‡,åˆ™è®¡ç®—è¡°å‡åçš„å€¼
    return counter;
}
// è·å–åˆ†çº§åˆ«çš„æ—¶é—´
unsigned long LFUGetTimeInMinutes(void) {
    return (server.unixtime/60) &amp; 65535;//è·å–åˆ†é’Ÿçº§åˆ«çš„æ—¶é—´æˆ³
}
</code></pre>
<p>æƒ³è¦äº†è§£LFUç®—æ³•ï¼Œä¸€å®šè¦å…ˆçœ‹è¿™æ®µæºç ï¼Œè¿™æ®µæ‘˜è‡ª<a href="https://segmentfault.com/a/1190000017555834">æ€å¦çš„ä¸€ç¯‡æ–‡ç« </a>ï¼ˆå°Šé‡åŸåˆ›ï¼‰ã€‚</p>
<blockquote>
<p>ç½‘ä¸Šå¾ˆå¤šè¿™æ®µä»£ç çš„æ³¨é‡Šï¼Œè‡³äºè°æ˜¯åŸè‘—ä¸å¤ªäº†è§£ï¼Œåœ¨è¿™é‡Œæˆ‘æŠŠå­¦ä¹ æ—¶çœ‹åˆ°çš„åŸæ–‡æ”¾ä¸Šå»ã€‚</p>
</blockquote>
<ol>
<li>counteræ›´æ–°<br>
æ›´æ–°çš„æ–¹æ³•ä¸­ä¸»è¦æœ‰ä¸‰è¡Œä»£ç ï¼Œç¬¬ä¸€è¡Œä»£ç åˆ¤æ–­counteræ˜¯å¦éœ€è¦é€’å‡ï¼Œç¬¬äºŒè¡Œå¯¹counterè¿›è¡Œå¢åŠ ï¼Œç¬¬ä¸‰è¡Œï¼Œæ›´æ–°counterä»¥åŠæœ€æ–°çš„æ—¶é—´ã€‚</li>
<li>counterè¡°å‡</li>
<li>counterå¢åŠ <br>
åœ¨çœ‹æºç çš„æ—¶å€™å¯¹äºéšæœºå€¼pä¸æ˜¯å¤ªç†è§£ï¼Œçœ‹åˆ°æ³¨é‡Šçš„æ—¶å€™æ‰æ˜ç™½ï¼ŒåŸæ¥counterå€¼çš„å¢åŠ ä¹Ÿæ˜¯ä¸€ä¸ªæ¦‚ç‡äº‹ä»¶ï¼Œå½“counterè¶Šæ¥è¶Šå¤§çš„æ—¶å€™å‘ç”Ÿ++çš„æ¦‚ç‡å°±è¶Šå°ã€‚</li>
</ol>
<h2 id="lru-lfuç®—æ³•æµ‹è¯•">lruã€lfuç®—æ³•æµ‹è¯•</h2>
<p>rediså®˜æ–¹æä¾›äº†ä¸€ä¸ªæµ‹è¯•å·¥å…·æ¥æµ‹è¯•lruç®—æ³•ä»¥åŠlfuç®—æ³•çš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æµ‹è¯•çš„ç»“æœäº†è§£lfuç®—æ³•å¸¦æ¥çš„æ•ˆæœä¼˜åŒ–ã€‚</p>
<ol>
<li>config set maxmemory 50m</li>
<li>config set maxmemory-policy allkeys-lru</li>
<li>./redis-cli -p 6380 --lru-test 1000000</li>
<li>info æŸ¥çœ‹æ·˜æ±°ç­–ç•¥å…·ä½“è¿‡ç¨‹</li>
</ol>
<blockquote>
<p>å»ºè®®è‡ªå·±æ“ä½œä¸‹lruç®—æ³•å’Œlfuç®—æ³•ï¼Œæ¯”å¯¹æµ‹è¯•ç»“æœã€‚è¿™é‡Œçš„æµ‹è¯•å‘½ä»¤å¥½åƒåªæœ‰lru-testï¼Œä¸å­˜åœ¨lfu-testğŸ˜§ã€‚</p>
</blockquote>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<ol>
<li><a href="http://antirez.com/news/109">reidsä½œè€…å…³äºLRUç®—æ³•çš„è®²è§£</a></li>
<li><a href="https://segmentfault.com/a/1190000017555834">redisæºç åˆ†æ</a></li>
</ol>

              </div>
              <div class="post-footer">
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
      Madara
    </li>
    <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://hsxyhao.github.io/post/redis-tao-tai-ji-zhi" title="cæ·˜æ±°æœºåˆ¶">https://hsxyhao.github.io/post/redis-tao-tai-ji-zhi</a>
    </li>
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
      æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–,è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>
  <div class="tags">
    
      <a href="https://hsxyhao.github.io/tag/Redis"># Redis</a>
    
  </div>
  <div class="nav">
    <div class="nav-prev">
      
        <i class="iconfont icon-angle_left"></i>
        <a href="https://hsxyhao.github.io/post/xiao-xi-dui-lie-xue-xi-kai-pian">æ¶ˆæ¯é˜Ÿåˆ—å­¦ä¹ å¼€ç¯‡</a>
      
    </div>
    <div class="nav-next">
      
          <a href="https://hsxyhao.github.io/post/vim-ming-ling-ji-lu">Vimå‘½ä»¤</a>
          <i class="iconfont icon-angle_right"></i>
      
    </div>
  </div>
</div>
              
                
                  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>
  var gitalk = new Gitalk({
    clientID: '7daf0c9da2ee9a72ecba',
    clientSecret: '39e3424bd496a5d8dcdbb618c370897256810975',
    repo: 'hsxyhao.github.io',
    owner: 'hsxyhao',
    admin: ['hsxyhao'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container')
</script>
                
                
              
            </div>
          </div>
        </div>
      </div>
      <div class="footer-box">
  <footer class="footer">
    <div class="copyright">
      Â© 2019-2020 <i class="iconfont icon-heart"></i> HsxyHao
    </div>
    <div class="poweredby">
      <div class="power-left">Power By<a href="https://github.com/hsxyhao"> HsxyHao</a></div>
      <div>Copy<a href="https://github.com/iissnan/hexo-theme-next"> Hexo Next Theme</a></div>
    </div>
  </footer>
  <div class="back-to-top" id="back_to_top">
    <i class="iconfont icon-arrow_up"></i>
    <span class="scrollpercent">
      <span id="back_to_top_text">100</span>%
    </span>
  </div>
</div>

<script>

  let body = document.body;

  let back2Top = document.querySelector('#back_to_top'),
  back2TopText = document.querySelector('#back_to_top_text');

  function scrollAnimation(currentY, targetY) {
    // è·å–å½“å‰ä½ç½®æ–¹æ³•
    // const currentY = document.documentElement.scrollTop || document.body.scrollTop

    // è®¡ç®—éœ€è¦ç§»åŠ¨çš„è·ç¦»
    let needScrollTop = targetY - currentY
    let _currentY = currentY
    setTimeout(() => {
      // ä¸€æ¬¡è°ƒç”¨æ»‘åŠ¨å¸§æ•°ï¼Œæ¯æ¬¡è°ƒç”¨ä¼šä¸ä¸€æ ·
      const dist = Math.ceil(needScrollTop / 10)
      _currentY += dist
      window.scrollTo(_currentY, currentY)
      // å¦‚æœç§»åŠ¨å¹…åº¦å°äºåä¸ªåƒç´ ï¼Œç›´æ¥ç§»åŠ¨ï¼Œå¦åˆ™é€’å½’è°ƒç”¨ï¼Œå®ç°åŠ¨ç”»æ•ˆæœ
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY)
      } else {
        window.scrollTo(_currentY, targetY)
      }
    }, 1)
  }

  back2Top.addEventListener("click", function(e) {
    scrollAnimation(body.scrollTop, 0);
    e.stopPropagation();
    return false;
  });
  
  window.addEventListener('scroll', function(e) {
    let percent = body.scrollTop / (body.scrollHeight - body.clientHeight) * 100;
    if (percent > 1 && !back2Top.classList.contains('back-top-active')) {
      back2Top.classList.add('back-top-active');
    }
    if (percent == 0) {
      back2Top.classList.remove('back-top-active');
    }
    back2TopText.textContent = Math.floor(percent);
  });
  // ä»£ç é«˜äº®
  hljs.initHighlightingOnLoad()
</script>
    </div>
  </body>
</html>